<div class="eventos-container p-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Eventos</h1>
    @if(esOrganizador){
    <button
      (click)="abrirModal()"
      class="bg-blue-400 text-black px-6 py-2 rounded hover:bg-blue-500 cursor-pointer font-semibold"
    >
      Crear Evento
    </button>
    }
  </div>

  <div
    class="flex flex-wrap items-center gap-3 mb-6 bg-white/70 border border-gray-200 rounded-lg px-4 py-3 shadow-sm"
  >
    <h3 class="text-sm font-semibold text-gray-700">Filtrar por:</h3>
    <div class="flex flex-wrap gap-2">
      <button
        class="px-4 py-2 rounded-full border text-sm font-semibold transition-colors"
        [class.bg-blue-400]="filtroActivo === 'todos'"
        [class.text-white]="filtroActivo === 'todos'"
        [class.border-blue-400]="filtroActivo === 'todos'"
        [class.bg-gray-50]="filtroActivo !== 'todos'"
        [class.text-gray-700]="filtroActivo !== 'todos'"
        [class.border-gray-200]="filtroActivo !== 'todos'"
        [class.hover\:bg-gray-100]="filtroActivo !== 'todos'"
        [class.hover\:border-blue-200]="filtroActivo !== 'todos'"
        (click)="filtrarTodos()"
      >
        Todos
      </button>
      <button
        class="px-4 py-2 rounded-full border text-sm font-semibold transition-colors"
        [class.bg-blue-400]="filtroActivo === 'proximos'"
        [class.text-white]="filtroActivo === 'proximos'"
        [class.border-blue-400]="filtroActivo === 'proximos'"
        [class.bg-gray-50]="filtroActivo !== 'proximos'"
        [class.text-gray-700]="filtroActivo !== 'proximos'"
        [class.border-gray-200]="filtroActivo !== 'proximos'"
        [class.hover\:bg-gray-100]="filtroActivo !== 'proximos'"
        [class.hover\:border-blue-200]="filtroActivo !== 'proximos'"
        (click)="filtrarProximos()"
      >
        Próximos
      </button>
      <button
        class="px-4 py-2 rounded-full border text-sm font-semibold transition-colors"
        [class.bg-blue-400]="filtroActivo === 'pasados'"
        [class.text-white]="filtroActivo === 'pasados'"
        [class.border-blue-400]="filtroActivo === 'pasados'"
        [class.bg-gray-50]="filtroActivo !== 'pasados'"
        [class.text-gray-700]="filtroActivo !== 'pasados'"
        [class.border-gray-200]="filtroActivo !== 'pasados'"
        [class.hover\:bg-gray-100]="filtroActivo !== 'pasados'"
        [class.hover\:border-blue-200]="filtroActivo !== 'pasados'"
        (click)="filtrarPasados()"
      >
        Pasados
      </button>
    </div>
  </div>

  @if (eventosFiltrados.length > 0) {
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    @for (evento of eventosFiltrados; track evento.idEvento) {
    <div
      class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300"
      [class.border-blue-500]="comprobarFechaProxima(evento)"
      [class.border-4]="comprobarFechaProxima(evento)"
    >
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-800 mb-2">
          {{ evento.fechaEvento }}
        </h2>

        @if (comprobarFechaProxima(evento)) {
        <span
          class="inline-block mt-2 bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-semibold"
        >
          Próximo
        </span>
        } @else {
        <span
          class="inline-block mt-2 bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold"
        >
          Pasado
        </span>
        }
      </div>

      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="flex flex-col gap-2">
          <button
            (click)="abrirModalDetalles(evento)"
            class="bg-green-300 text-black px-6 py-2 rounded hover:bg-green-500 cursor-pointer font-semibold w-full"
          >
            Detalles
          </button>
          @if (comprobarFechaProxima(evento)) {
            <button
              (click)="abrirModalInscripcion(evento)"
              class="bg-blue-400 text-black px-6 py-2 rounded hover:bg-blue-500 cursor-pointer font-semibold w-full"
            >
              Inscribirme
            </button>
          } @else {
            @if (esCapitan) {
              <div class="grid grid-cols-2 gap-2">
                <button
                  (click)="abrirModalCrearResultado(evento)"
                  class="bg-blue-400 text-black px-4 py-2 rounded hover:bg-blue-500 cursor-pointer font-semibold w-full"
                >
                  Crear Resultado
                </button>
                <a
                  [routerLink]="['/eventos', evento.idEvento, 'resultados']"
                  class="bg-gray-400 text-black px-4 py-2 rounded hover:bg-gray-500 cursor-pointer font-semibold w-full text-center no-underline"
                >
                  Ver Resultados
                </a>
              </div>
            } @else {
              <a
                [routerLink]="['/eventos', evento.idEvento, 'resultados']"
                class="bg-gray-400 text-black px-6 py-2 rounded hover:bg-gray-500 cursor-pointer font-semibold w-full text-center no-underline"
              >
                Ver Resultados
              </a>
            }
          }
        </div>
      </div>
    </div>
    }
  </div>
  } @else {
  <div class="bg-white p-8 rounded-lg shadow-md text-center">
    <p class="text-gray-600 text-lg">No hay eventos disponibles</p>
  </div>
  }

  <!-- Modal para crear evento -->
  @if (mostrarModal) {
  <div
    class="fixed inset-0 flex items-center justify-center z-50 backdrop-blur-sm bg-white/30"
    (click)="cerrarModal()"
  >
    <div
      class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 relative z-10 border border-gray-200"
      (click)="$event.stopPropagation()"
      style="background-color: white"
    >
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Crear Nuevo Evento</h2>
        <button
          (click)="cerrarModal()"
          class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
        >
          ×
        </button>
      </div>

      <!-- Loader mientras se insertan actividades -->
      @if(insertandoActividades) {
      <div class="absolute inset-0 bg-white/90 backdrop-blur-sm rounded-lg flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mb-4"></div>
        <p class="text-gray-700 font-semibold text-lg">Insertando actividades...</p>
        <p class="text-gray-500 text-sm mt-2">Por favor, espera un momento</p>
      </div>
      }

      <form (ngSubmit)="crearEvento()">
        <div class="mb-4">
          <label
            for="fechaEvento"
            class="block text-sm font-semibold text-gray-700 mb-2"
          >
            Fecha del Evento
          </label>
          <input
            type="date"
            id="fechaEvento"
            [(ngModel)]="nuevoEvento.fechaEvento"
            name="fechaEvento"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
          />
        </div>

        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-800">
            <strong>Nota:</strong> Un profesor será asignado automáticamente de
            forma aleatoria, priorizando aquellos que aún no tienen eventos
            asignados.
          </p>
        </div>

        @if(actividades && actividades.length > 0) {
        <div class="actividades-section">
          <label>Seleccionar Actividades</label>
          @for(actividad of actividades; track actividad.idActividad){
          <div class="checkbox-wrapper flex items-center gap-2">
            <div class="flex items-center flex-1">
              <input
                type="checkbox"
                [id]="'actividad-' + actividad.idActividad"
                [value]="actividad.idActividad"
                (change)="onActividadSeleccionada(actividad, $event)"
                class="custom-checkbox"
              />
              <label
                [for]="'actividad-' + actividad.idActividad"
                class="checkbox-label"
              >
                <div class="checkbox-custom"></div>
                <span class="checkbox-text">{{ actividad.nombre }}</span>
              </label>
            </div>
            @if(actividadEstaPrecioSeleccionada(actividad.idActividad)){
            <div class="flex items-center gap-2">
              <label class="text-sm font-semibold text-gray-700">Precio (€):</label>
              <input
                type="number"
                min="0"
                step="0.01"
                [(ngModel)]="preciosActividades[actividad.idActividad]"
                [name]="'precio-' + actividad.idActividad"
                placeholder="0.00"
                class="w-24 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-400 focus:border-transparent"
              />
            </div>
            }
          </div>
          }
        </div>
        }

        <div class="flex gap-3">
          <button
            type="button"
            (click)="cerrarModal()"
            class="flex-1 bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400 font-semibold"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 bg-blue-400 text-black px-4 py-2 rounded hover:bg-blue-500 font-semibold"
          >
            Crear Evento
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Modal para mostrar detalles del evento -->
  <app-detalles
    [evento]="eventoSeleccionado"
    [mostrar]="mostrarModalDetalles && eventoSeleccionado !== undefined"
    [mostrarFormularioInmediato]="mostrarFormularioInmediato"
    (cerrar)="cerrarModalDetalles()"
  ></app-detalles>

  <!-- Modal para crear resultado (capitán) -->
  @if (mostrarModalCrearResultado && eventoCrearResultado) {
  <div
    class="fixed inset-0 flex items-center justify-center z-50 backdrop-blur-sm bg-white/30"
    (click)="cerrarModalCrearResultado()"
  >
    <div
      class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 relative z-10 border border-gray-200"
      (click)="$event.stopPropagation()"
      style="background-color: white"
    >
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Crear Resultado</h2>
        <button
          (click)="cerrarModalCrearResultado()"
          class="text-gray-500 hover:text-gray-700 text-2xl font-bold"
          aria-label="Cerrar"
        >
          ×
        </button>
      </div>

      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
          <strong>Evento:</strong> {{ formatearFecha(eventoCrearResultado.fechaEvento) }}
        </p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Actividad</label>
        <select
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
          [(ngModel)]="formResultado.idEventoActividad"
          (change)="onActividadEventoCrearChange()"
          name="idEventoActividad"
        >
          <option [ngValue]="0">Selecciona una actividad</option>
          @for (a of actividadesEventoCrear; track a.idEventoActividad) {
            <option [ngValue]="a.idEventoActividad">{{ a.nombreActividad }}</option>
          }
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Equipo local</label>
          <select
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
            [(ngModel)]="formResultado.idEquipoLocal"
            name="idEquipoLocal"
          >
            <option [ngValue]="0">Selecciona</option>
            @for (e of equiposCrear; track e.idEquipo) {
              <option [ngValue]="e.idEquipo">{{ e.nombreEquipo }}</option>
            }
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Equipo visitante</label>
          <select
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
            [(ngModel)]="formResultado.idEquipoVisitante"
            name="idEquipoVisitante"
          >
            <option [ngValue]="0">Selecciona</option>
            @for (e of equiposCrear; track e.idEquipo) {
              <option [ngValue]="e.idEquipo">{{ e.nombreEquipo }}</option>
            }
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Puntos local</label>
          <input
            type="number"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
            [(ngModel)]="formResultado.puntosLocal"
            name="puntosLocal"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Puntos visitante</label>
          <input
            type="number"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent"
            [(ngModel)]="formResultado.puntosVisitante"
            name="puntosVisitante"
          />
        </div>
      </div>

      <div class="flex gap-3">
        <button
          type="button"
          (click)="cerrarModalCrearResultado()"
          class="flex-1 bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400 font-semibold"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="crearResultado()"
          class="flex-1 bg-blue-400 text-black px-4 py-2 rounded hover:bg-blue-500 font-semibold"
        >
          Crear
        </button>
      </div>
    </div>
  </div>
  }
</div>
